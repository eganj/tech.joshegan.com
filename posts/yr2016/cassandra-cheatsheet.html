<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="HandheldFriendly" content="True"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="description" content="Cheatsheet for cassandra"/><meta property="og:description" content="Cheatsheet for cassandra"/><meta property="og:site_name" content="tech.joshegan.com"/><meta property="og:title" content="Cassandra Cheatsheet - tech.joshegan.com"><title>Cassandra Cheatsheet - tech.joshegan.com</title><meta property="og:url" content="http://tech.joshegan.com/posts/yr2016/cassandra-cheatsheet"><meta property="og:type" content="article"><link rel="stylesheet" type="text/css" href="/styles/third-party/google-fonts/css/google-fonts.css"/><link rel="stylesheet" type="text/css" href="/styles/third-party/font-awesome-4.3.0/css/font-awesome.min.css"/><link rel="stylesheet" type="text/css" href="/styles/main.css"/><link rel="stylesheet" type="text/css" href="/styles/third-party/highlight-js/hybrid.css"><script src="/scripts/sidebar-opacity.js"></script></head><body id="body" class="post-wrapper"><header class="nav mobile-nav"><a href="/"><i class="fa fa-home fa-2x"></i><span>tech.joshegan.com</span></a></header><article class="post"><h1><a href="http://tech.joshegan.com/posts/yr2016/cassandra-cheatsheet">Cassandra Cheatsheet</a></h1><p></p>Posted on<time datetime="2016-04-18"><strong> April 18th, 2016</strong></time>, updated on<time datetime="2017-01-04" class="orange"><strong> January 4th, 2017</strong></time><h2>Cassandra Resources</h2>
<ul>
<li><a href="https://cassandra.apache.org/">https://cassandra.apache.org/</a></li>
<li><a href="http://techblog.netflix.com/2011/11/benchmarking-cassandra-scalability-on.html">http://techblog.netflix.com/2011/11/benchmarking-cassandra-scalability-on.html</a></li>
<li><a href="https://app.pluralsight.com/library/courses/cassandra-developers">https://app.pluralsight.com/library/courses/cassandra-developers</a></li>
</ul>
<h2>About Cassandra</h2>
<h3>History</h3>
<ul>
<li>Originally created at Facebook.</li>
<li>Open sourced and now an official apache project.</li>
</ul>
<h3>When to use Cassandra</h3>
<p>Cassandra is a great choice for a database when...</p>
<ul>
<li>Speed is the top goal and eventual consistency is acceptable.</li>
<li>Table schema is stable and unlikely to change.</li>
</ul>
<h3>High Level Overview</h3>
<p>Cassandra nodes are typically represented in a ring because there is no master node - it is a true peer to peer system.</p>
<p>All data stored in Cassandra is associated with a token value. Each data center has a set of token values, and each node in the data center is assigned to manage a portion of the token values. Virtual nodes can exist within each node. Virtual nodes distribute the load of token values somewhat randomly, making it so that each vnode is replicated on a different node. See <a href="http://www.datastax.com/dev/blog/virtual-nodes-in-cassandra-1-2">this article</a> for further reading.</p>
<h3>Terminology</h3>
<table>
<thead>
<tr>
<th>Term</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>node</td>
<td>A server running an instance of cassandra.</td>
</tr>
<tr>
<td>token</td>
<td>A single token associated with a piece of data. &quot;Token&quot; is also often used to refer to a range of tokens.</td>
</tr>
<tr>
<td>vnode</td>
<td>A virtual node. Virtual nodes are used to distribute token values on a single physical node.</td>
</tr>
<tr>
<td>snitch</td>
<td>Snitches are used by cassandra internally to learn about the nodes. See SimpleSnitch, GossipingPropertyFileSnitch, PropetyFileSnitch, etc.</td>
</tr>
<tr>
<td>dc</td>
<td>A data center is a grouping of nodes. Each data center has its own set of tokens.</td>
</tr>
<tr>
<td>rack</td>
<td>Each node in a data center is part of a rack. Racks do not require an even distribution of nodes. Data center replication will be evenly distributed among racks. Each rack will evenly distribute the replication among the nodes on the rack.</td>
</tr>
<tr>
<td>keyspace</td>
<td>Data is organized at the highest level into keyspaces. The oracle or mysql analog is tablespace. Replication is specified at the keyspace level.</td>
</tr>
<tr>
<td>table</td>
<td>Pretty close to mysql definition - columns are defined, and rows of data are stored in the table.</td>
</tr>
<tr>
<td>partition</td>
<td>All data is associated with a partition key. A table contains partitions.</td>
</tr>
<tr>
<td>row</td>
<td>Also close to mysql definition. Rows represent data within paritions.</td>
</tr>
</tbody>
</table>
<h3>Naming Conventions / Rules</h3>
<p><strong>Best advice:</strong> Don't get creative. Stick with alpha, lowercase, snake-case names.</p>
<ul>
<li>Snake-case is the preferred naming style in Cassandra (e.g. <code>my_table</code>)</li>
<li>No hyphens (e.g. <code>my-table</code>)</li>
<li>No spaces (e.g. <code>my table</code>)</li>
<li>Double quotes are required if something starts with a number (e.g. <code>&quot;2050predictions&quot;</code>)</li>
<li>Double quotes are required if mixed case names are used (e.g. <code>&quot;myTable&quot;</code>)</li>
</ul>
<h2>Setting up a Cassandra cluster</h2>
<h3>Creating a Sandbox Cluster</h3>
<p>This sandbox is created using <a href="https://www.docker.com/">docker</a>, <a href="https://www.virtualbox.org/">VirtualBox</a>, and <a href="http://boot2docker.io/">boot2docker</a>.</p>
<pre><code class="language-bash">boot2docker --memory=<span class="hljs-number">4096</span> init
boot2docker up
$(boot2docker shellinit)
boot2docker status

docker run --name=n1 <span class="hljs-operator">-d</span> tobert/cassandra
docker <span class="hljs-built_in">exec</span> -it n1 nodetool status
docker <span class="hljs-built_in">exec</span> -it n1 nodetool ring
docker inspect <span class="hljs-operator">-f</span> <span class="hljs-string">'{{ .NetworkSettings.IPAddress}}'</span> n1
<span class="hljs-comment">#The inspect command will output an IP address to be used in the next command</span>
docker run --name n2 <span class="hljs-operator">-d</span> tobert/cassandra -seeds <span class="hljs-number">000.00</span>.<span class="hljs-number">0.0</span>
</code></pre>
<h3>cassandra.yaml</h3>
<p>Cassandra configuration is stored in <code>cassandra.yaml</code> file. By default this file is located at <code>/data/conf/cassandra.yaml</code>.</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>num_tokens</code></td>
<td>The number of virtual nodes, <code>vnodes</code>, to use in this node. Default is 256.</td>
</tr>
<tr>
<td><code>seed_provider</code></td>
<td>Defines the seeds for the node.</td>
</tr>
<tr>
<td><code>endpoint_snitch</code></td>
<td>The snitch type for the node.</td>
</tr>
</tbody>
</table>
<h3>Creating Cassandra Nodes with Docker</h3>
<pre><code class="language-bash">docker run --name n2 <span class="hljs-operator">-d</span> tobert/cassandra -seeds <span class="hljs-number">000.00</span>.<span class="hljs-number">0.0</span> -dc DC1 -rack RACK1
</code></pre>
<table>
<thead>
<tr>
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-seeds</code></td>
<td>When adding a new node to an existing Cassandra cluster, the new node should be initialized with a comma separated list of ip addresses of existing nodes using <code>-seeds &lt;ip-address-1&gt;,&lt;ip-address-2&gt;</code></td>
</tr>
<tr>
<td><code>-dc</code></td>
<td>Give a name of the data center. e.g. <code>-dc DC-1</code></td>
</tr>
<tr>
<td><code>-rack</code></td>
<td>Give the rack name. e.g. <code>-rack R-1</code></td>
</tr>
</tbody>
</table>
<h3>cassandra-rackdc.properties</h3>
<p>By default, this file is located at <code>/data/conf/cassandra-rackdc.properties</code></p>
<p>The <code>dc</code> (data center) and <code>rack</code> are stored in this properties file. This file is read in at node start-up and gossiped out to the other nodes in the cluster.</p>
<h2>Working with cassandra</h2>
<h3>CQLSH</h3>
<p>The cqlsh command line utility allows for interacting with Cassandra directly.</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>cqlsh</code></td>
<td>Launch the shell and connect to the default node. Default is <code>localhost:9160</code>; this can be changed by setting <code>$CQLSH_HOST</code> and/or <code>$CQLSH_PORT</code></td>
</tr>
<tr>
<td><code>cqlsh -h</code></td>
<td>Display the help docs.</td>
</tr>
<tr>
<td><code>cqlsh &lt;address&gt;</code></td>
<td>Connect to a remote node. The address can be an ip address or a url.</td>
</tr>
<tr>
<td><code>cqlsh &lt;address&gt; -u &lt;user-name&gt;</code></td>
<td>Connect to a remote with the specified user. This will open up an interactive prompt if a password is required.</td>
</tr>
<tr>
<td><code>cqlsh &lt;address&gt; -u &lt;user-name&gt; -p &lt;password&gt;</code></td>
<td>Authenticated remote login. Note that password will be visible as plain text on console if <code>-p</code> is used.</td>
</tr>
<tr>
<td><code>cqlsh -k &lt;keyspace&gt;</code></td>
<td>Authenticate to the provided keyspace.</td>
</tr>
<tr>
<td><code>cqlsh -f &lt;file-path.cql&gt;</code></td>
<td>Execute commands from the file and then exit.</td>
</tr>
<tr>
<td><code>cqlsh -e &quot;&lt;cql-command&gt;&quot;</code></td>
<td>Execute a CQL command and then exit. For example, <code>cqlsh -e &quot;SELECT id FROM sample_keyspace.my_table&quot;</code></td>
</tr>
<tr>
<td><code>cqlsh --cqlversion=&lt;version&gt;</code></td>
<td>Use the specified version of CQL. For example, <code>cqlsh --cqlversion=3.0.3</code></td>
</tr>
</tbody>
</table>
<p>Once inside of a cqlsh prompt, these commands are available:</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>help</code></td>
<td>Show the help docs.</td>
</tr>
<tr>
<td><code>use &lt;keyspace&gt;</code></td>
<td>Use the specified keyspace. Allows accessing tables without prefixing with <code>keyspace.</code>.</td>
</tr>
<tr>
<td><code>tracing &lt;on/off&gt;</code></td>
<td>Turn tracing on or off</td>
</tr>
<tr>
<td><code>desc</code></td>
<td>Describe a keyspace or table.</td>
</tr>
<tr>
<td><code>source &lt;filepath&gt;</code></td>
<td>Execute a file containing CQL statements.</td>
</tr>
<tr>
<td><code>expand &lt;on/off&gt;</code></td>
<td>If <code>expand</code> is on, each row printed to the console will be on its own line. Much easier to read!</td>
</tr>
<tr>
<td><code>nodetool</code></td>
<td>Useful tool for interacting with nodes. The <code>nodetool</code> command can be run from cqlsh on any node in the cluster and will yield the same results.</td>
</tr>
<tr>
<td><code>nodetool help</code></td>
<td>Display help docs.</td>
</tr>
<tr>
<td><code>nodetool status</code></td>
<td>Shows the status of the cassandra nodes in the cluster</td>
</tr>
<tr>
<td><code>nodetool status &lt;keyspace&gt;</code></td>
<td>Shows the status of the cassandra nodes that own the specified keyspace.</td>
</tr>
<tr>
<td><code>nodetool ring</code></td>
<td>Shows the token ranges for the node. Each row represents a <code>vnode</code></td>
</tr>
<tr>
<td><code>nodetool describering &lt;keyspace&gt;</code></td>
<td>Shows the token ranges where all data would go for the specified keyspace.</td>
</tr>
<tr>
<td><code>nodetool repair</code></td>
<td>Repair inconsistencies in data across nodes.</td>
</tr>
<tr>
<td><code>nodetool pausehandoff</code></td>
<td>Pauses automatic hand-offs, or data repair. Can be useful when trying to trace hand-offs.</td>
</tr>
<tr>
<td><code>nodetool cfstats &lt;table-name&gt;</code></td>
<td>Displays detailed stats on the table, including read and write activity. Useful for ensuring that a table really is not in use before dropping it.</td>
</tr>
</tbody>
</table>
<h3>CQL (Cassandra Query Language)</h3>
<p>Cassandra originally using a Thrift API (2008). CQL was introduced in Cassandra 0.8 in 2011.</p>
<p>CQL interacts with keyspaces, tables, and rows. Partitions, are implicitly handled within tables.</p>
<p><em>Note</em> - both <code>INSERT</code> and <code>UPDATE</code> are functionally upsert statements (insert or update).
<em>Note</em> - Use the <code>IN ()</code> selector with caution. An <code>IN</code> will cause a single coordinator node to search through multiple partitions. It can become more efficient to perform multiple select queries rather than using a large IN clause to do a single select.</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
<th>Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CREATE</code></td>
<td>Use to create a keyspace or table.</td>
<td><code>CREATE KEYSPACE sample WITH REPLICATION = {'class':'SimpleStrategy','replication_factor':3};</code><br><br><code>CREATE TABLE my_table (id text, size int, PRIMARY KEY (id))</code></td>
</tr>
<tr>
<td><code>INSERT</code></td>
<td>Use to update or insert table data.</td>
<td><code>INSERT INTO my_table (id) VALUES ('guid');</code></td>
</tr>
<tr>
<td><code>UPDATE</code></td>
<td>Update or insert data in a table.</td>
<td><code>UPDATE my_table SET author = 'paul-ofallon' WHERE id = 'cassandra-developers';</code></td>
</tr>
<tr>
<td><code>DELETE</code></td>
<td>Delete data from a table.</td>
<td><code>DELETE FROM my_table WHERE id = 'asdf'</code></td>
</tr>
<tr>
<td><code>DROP</code></td>
<td>Drop / delete a table or keyspace.</td>
<td><code>DROP KEYSPACE sample;</code><br><br><code>DROP TABLE my_table;</code></td>
</tr>
<tr>
<td><code>ALTER</code></td>
<td>Alter a table or keyspace.</td>
<td><code>ALTER KEYSPACE sample WITH DURABLE_WRITES = true;</code></td>
</tr>
<tr>
<td><code>TRUNCATE</code></td>
<td>Remove all data from a table.</td>
<td><code>TRUNCATE my_table;</code></td>
</tr>
<tr>
<td><code>WITH</code></td>
<td>Used to specify properties.</td>
<td><code>CREATE TABLE my_table (id varchar PRIMARY KEY) WITH comment='A table';</code></td>
</tr>
<tr>
<td><code>WRITETIME</code></td>
<td>Function that returns a unix timestamp for when something was written.</td>
<td><code>SELECT id, WRITETIME(author) FROM my_table;</code></td>
</tr>
</tbody>
</table>
<p><strong>CQL Examples</strong></p>
<pre><code class="language-sql"><span class="hljs-operator"><span class="hljs-keyword">CREATE</span> KEYSPACE pluralsight <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">REPLICATION</span> = {<span class="hljs-string">'class'</span>:<span class="hljs-string">'SimpleStrategy'</span>,<span class="hljs-string">'replication_factor'</span>:<span class="hljs-number">1</span>};</span>

<span class="hljs-operator"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> courses (<span class="hljs-keyword">id</span> <span class="hljs-built_in">varchar</span> PRIMARY <span class="hljs-keyword">KEY</span>);</span>
<span class="hljs-operator"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> courses (<span class="hljs-keyword">id</span> <span class="hljs-built_in">VARCHAR</span> PRIMARY <span class="hljs-keyword">KEY</span>);</span>
<span class="hljs-operator"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> courses <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">duration</span> <span class="hljs-built_in">int</span>;</span>
<span class="hljs-operator"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> courses <span class="hljs-keyword">ADD</span> released <span class="hljs-keyword">timestamp</span>;</span>
<span class="hljs-operator"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> courses <span class="hljs-keyword">ADD</span> author <span class="hljs-built_in">varchar</span>;</span>
<span class="hljs-operator"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> courses;</span>

<span class="hljs-operator"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> courses (
  <span class="hljs-keyword">id</span> <span class="hljs-built_in">varchar</span> PRIMARY <span class="hljs-keyword">KEY</span>,
  <span class="hljs-keyword">name</span> <span class="hljs-built_in">varchar</span>,
  author <span class="hljs-built_in">varchar</span>,
  audience <span class="hljs-built_in">int</span>,
  <span class="hljs-keyword">duration</span> <span class="hljs-built_in">int</span>,
  hasClosedCaptions <span class="hljs-built_in">boolean</span>,
  released <span class="hljs-keyword">timestamp</span>
);</span>

<span class="hljs-operator"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, title <span class="hljs-keyword">FROM</span> pluralsight.courses;</span>
<span class="hljs-operator"><span class="hljs-keyword">SELECT</span> title, <span class="hljs-keyword">duration</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">length</span> <span class="hljs-keyword">FROM</span> pluralsight.courses <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'cassandra-developers'</span>;</span>
<span class="hljs-operator"><span class="hljs-keyword">SELECT</span> title, published <span class="hljs-keyword">FROM</span> pluralsight.courses <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'cassandra-developers'</span>, <span class="hljs-string">'node-intro'</span>);</span>
<span class="hljs-operator"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pluralsight.courses <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">100</span>;</span>

<span class="hljs-operator"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> pluralsight.courses (<span class="hljs-keyword">id</span>, author) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'cassandra-developers'</span>, <span class="hljs-string">'paul-ofallon'</span>);</span>
<span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> pluralsight.courses <span class="hljs-keyword">SET</span> author = <span class="hljs-string">'paul-ofallon'</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'cassandra-developers'</span>;</span>
<span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> pluralsight.courses <span class="hljs-keyword">SET</span> author = <span class="hljs-string">'paul-ofallon'</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'cassandra-developers'</span>, <span class="hljs-string">'node-intro'</span>);</span>

<span class="hljs-operator"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, WRITETIME(author) <span class="hljs-keyword">FROM</span> pluralsight.courses;</span>

<span class="hljs-comment">-- Delete a row</span>
<span class="hljs-operator"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> pluralsight.courses <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'node-intro'</span>;</span>

<span class="hljs-comment">-- Delete a column</span>
<span class="hljs-operator"><span class="hljs-keyword">DELETE</span> author <span class="hljs-keyword">FROM</span> pluralsight.courses <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'node-intro'</span>;</span>
<span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> pluralsight.courses <span class="hljs-keyword">SET</span> author = <span class="hljs-literal">null</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'node-intro'</span>;</span>
<span class="hljs-operator"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> pluralsight.courses (<span class="hljs-keyword">id</span>, author) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'node-intro'</span>, <span class="hljs-literal">null</span>);</span>

<span class="hljs-comment">-- Use a TTL (length of time in seconds) for a single column</span>
<span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> pluralsight.<span class="hljs-keyword">users</span> <span class="hljs-keyword">USING</span> TTL <span class="hljs-number">32400</span> <span class="hljs-keyword">SET</span> reset_token = <span class="hljs-string">'asdf'</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'john-doe'</span>;</span>
<span class="hljs-operator"><span class="hljs-keyword">SELECT</span> TTL(reset_token) <span class="hljs-keyword">FROM</span> pluralsight.<span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'john-doe'</span>;</span>

<span class="hljs-comment">-- Use a TTL for an entire row</span>
<span class="hljs-comment">-- Only insert statements can be used to set a TTL for an entire row. Can't be done with UPDATE.</span>
<span class="hljs-operator"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> pluralsight.reset_tokens (<span class="hljs-keyword">id</span>, token) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'john-doe'</span>, <span class="hljs-string">'asdoij'</span>) <span class="hljs-keyword">USING</span> TTL <span class="hljs-number">10800</span>;</span>

<span class="hljs-comment">-- Use a TTL for the entire table. The entire table will be tombstoned after the TTL expires.</span>
<span class="hljs-operator"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> reset_tokens (
  <span class="hljs-keyword">id</span> <span class="hljs-built_in">varchar</span> PRIMARY <span class="hljs-keyword">KEY</span>,
  token <span class="hljs-built_in">varchar</span>
) <span class="hljs-keyword">WITH</span> default_time_to_live = <span class="hljs-number">10800</span>;</span>

<span class="hljs-comment">-- If you have a table of id, partition_key, and you want to get one row for each id and the first partition_key, you can use this query:</span>
<span class="hljs-operator"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">id</span>, partition_key <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">table</span>;</span>

<span class="hljs-comment">-- Working with Collections</span>
<span class="hljs-comment">-- set&lt;type&gt;</span>
<span class="hljs-operator"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> courses (<span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span>, features) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'node-intro'</span>, <span class="hljs-string">'Introduction to Node.js'</span>, {<span class="hljs-string">'cc'</span>, <span class="hljs-string">'transcript'</span>});</span>
<span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> courses <span class="hljs-keyword">SET</span> features = features + {<span class="hljs-string">'cc'</span>} <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'node-intro'</span>;</span> <span class="hljs-comment">-- the + symbol adds to the set.</span>
<span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> courses <span class="hljs-keyword">SET</span> features = features - {<span class="hljs-string">'cc'</span>} <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'node-intro'</span>;</span> <span class="hljs-comment">-- the - symbol removes from the set.</span>
<span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> courses <span class="hljs-keyword">SET</span> features = {} <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'node-intro'</span>;</span> <span class="hljs-comment">-- create an empty set.</span>

<span class="hljs-comment">-- list&lt;type&gt;</span>
<span class="hljs-operator"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> courses (<span class="hljs-keyword">id</span>, clips) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'node-intro'</span>, [<span class="hljs-string">'Getting Started'</span>]);</span>
<span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> courses <span class="hljs-keyword">SET</span> clips = [<span class="hljs-string">'Introduction'</span>] + clips <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'node-intro'</span>;</span> <span class="hljs-comment">-- prepend to the front of the list</span>
<span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> courses <span class="hljs-keyword">SET</span> clips = clips + [<span class="hljs-string">'Introduction'</span>] <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'node-intro'</span>;</span> <span class="hljs-comment">-- append to the back of the list</span>
<span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> courses <span class="hljs-keyword">SET</span> clips = clips - [<span class="hljs-string">'Introduction'</span>] <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'node-intro'</span>;</span> <span class="hljs-comment">-- removes all matching elements from the list.</span>
<span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> courses <span class="hljs-keyword">SET</span> clips[<span class="hljs-number">0</span>] = <span class="hljs-string">'Introduction'</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'node-intro'</span>;</span> <span class="hljs-comment">-- add to list by position. Use indexing as you would in an array.</span>
<span class="hljs-operator"><span class="hljs-keyword">DELETE</span> clips[<span class="hljs-number">0</span>] <span class="hljs-keyword">FROM</span> courses <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'node-intro'</span>;</span>

<span class="hljs-comment">-- map&lt;key-type,value-type&gt;</span>
<span class="hljs-operator"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">users</span> (<span class="hljs-keyword">id</span>, last_login) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'john-doe'</span>, {<span class="hljs-string">'abcde'</span>: <span class="hljs-string">'2015-06-30 09:02:24'</span>});</span>
<span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">SET</span> last_login[<span class="hljs-string">'abcde'</span>] = <span class="hljs-string">'2015-09-12 07:01:34'</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'john-doe'</span>;</span>
<span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">SET</span> last_login = last_login + {<span class="hljs-string">'abcde'</span>: <span class="hljs-string">'2015-06-30 09:02:24'</span>} <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'john-doe'</span>;</span>
<span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">SET</span> last_login = last_login - {<span class="hljs-string">'abcde'</span>: <span class="hljs-string">'2015-06-30 09:02:24'</span>} <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'john-doe'</span>;</span>
<span class="hljs-operator"><span class="hljs-keyword">DELETE</span> last_login[<span class="hljs-string">'abcde'</span>] <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'john-doe'</span>
<span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">set</span> last_login = {} <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-string">'john-doe'</span>

<span class="hljs-comment">-- secondary indexes</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (<span class="hljs-keyword">id</span> <span class="hljs-built_in">varchar</span>, first_name <span class="hljs-built_in">varchar</span>, tags <span class="hljs-keyword">set</span>&lt;<span class="hljs-built_in">varchar</span>&gt;, PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-keyword">id</span>));</span>
<span class="hljs-operator"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">users</span>(tags);</span>
<span class="hljs-operator"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">users</span> (<span class="hljs-keyword">id</span>, first_name, tags) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'john-doe'</span>,<span class="hljs-string">'John'</span>, {<span class="hljs-string">'java'</span>});</span>
<span class="hljs-operator"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> tags CONTAINS <span class="hljs-string">'java'</span>;</span>

<span class="hljs-comment">-- a secondary index for a map</span>
<span class="hljs-operator"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">table</span>(<span class="hljs-keyword">KEYS</span>(map_column));</span>
<span class="hljs-operator"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">WHERE</span> map_column CONTAINS <span class="hljs-keyword">KEY</span> <span class="hljs-string">'foo'</span>;</span>
</code></pre>
<h3>Cassandra Data Types</h3>
<p><a href="http://docs.datastax.com/en/cql/3.3/cql/cql_reference/cql_data_types_c.html">http://docs.datastax.com/en/cql/3.3/cql/cql_reference/cql_data_types_c.html</a></p>
<ul>
<li>Numeric
<ul>
<li><code>bigint</code></li>
<li><code>decimal</code></li>
<li><code>double</code></li>
<li><code>float</code></li>
<li><code>int</code></li>
<li><code>varint</code></li>
<li><code>counter</code></li>
</ul>
</li>
<li>String
<ul>
<li><code>ascii</code></li>
<li><code>text</code></li>
<li><code>varchar</code></li>
</ul>
</li>
<li>Date
<ul>
<li><code>timestamp</code></li>
<li><code>timeuuid</code></li>
</ul>
</li>
<li>Other
<ul>
<li><code>boolean</code></li>
<li><code>uuid</code></li>
<li><code>inet</code></li>
<li><code>blob</code></li>
</ul>
</li>
<li>Collections
<ul>
<li>TTLs work for individual elements in a collection rather than the entire collection.</li>
<li><code>set&lt;int&gt;</code> A set allows only unique values and does not preserve order.</li>
<li><code>list&lt;int&gt;</code> A list allows duplicate values and preserves order.</li>
<li><code>map&lt;text,timestamp&gt;</code> A map is a dictionary of key value pairs.</li>
<li><code>tuple&lt;int,text,varchar,double,int&gt;</code> A tuple can have many different data types, but they must always appear in the same order.</li>
<li>Complex types can be nested. e.g. <code>map&lt;text,frozen&lt;tuple&lt;int,double&gt;&gt;&gt;</code>. Whenever a complex type is nested, it must be <code>frozen</code>. Nested complex types are written and read as blobs, so they are not particularly efficient.</li>
<li>User Defined types
<ul>
<li><code>CREATE TYPE clip (name varchar, duration int);</code></li>
<li><code>CREATE TYPE person (name varchar, id varchar);</code></li>
<li><code>CREATE TABLE courses (id text, author frozen&lt;person&gt;);</code></li>
<li>User defined types must always use the frozen keyword.</li>
<li>User defined types have the following advantages over using a tuple:
<ul>
<li>Ability to identify components by name, not just order.</li>
<li>Can be very helpful when multiple components have the same type.</li>
<li>Can be used across multiple tables.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3>keyspace</h3>
<p>Replication strategy is defined at the keyspace level.</p>
<h4>SimpleStrategy</h4>
<p>The <code>replication_factor</code> tells cassandra how many copies of each partition in the keyspace to store.</p>
<p><code>create keyspace &lt;keyspace-name&gt; with replication = {'class': 'SimpleStrategy', 'replication_factor': 3};</code></p>
<h4>NetworkTopologyStrategy</h4>
<p>When using NetworkTopologyStrategy, you specify how many copies of each partition to store in each data center.</p>
<p><code>create keyspace &lt;keyspace-name&gt; with replication = {'class': 'NetworkTopologyStrategy', '&lt;dc-name&gt;': 3, '&lt;dc-name&gt;': 2};</code></p>
<h3>tables</h3>
<h4>partition keys</h4>
<p>The primary key is defined as the first partition key.</p>
<p>A single primary key can be specified using <code>CREATE TABLE my_table (id varchar PRIMARY KEY, title varchar);</code> or <code>CREATE TABLE my_table (id varchar, title varchar, PRIMARY KEY (id))</code>.</p>
<p>A composite primary key is specified using <code>CREATE TABLE my_table (id varchar, title varchar, name varchar, PRIMARY KEY ((id, title)));</code></p>
<h4>clustering keys</h4>
<p>A composite key is specified using <code>PRIMARY KEY(partition_key, clustering_key)</code>. For example: <code>CREATE TABLE my_table (id varchar, title varchar, name varchar, PRIMARY KEY (id, title));</code></p>
<p>When clustering keys are used, the data inserted can be visualized as an entirely separate row. All of the common data must be inserted each time unless static columns are used.</p>
<p>A partition can hold a maximum of 2 billion cells. All of the data from a single partition must fit on a single node in the cluster. To address these limitations, consider ways to appropriately bucket the data. For example, when storing timestamps for events, buckets could be created for year, month, and day, depending on the volume that is anticipated. Another approach would be to create a <code>bucket_id</code> key that is a string of your choosing (e.g. <code>&quot;2016-12-07&quot;</code>).</p>
<h4>static</h4>
<p>The <code>STATIC</code> modifying makes static fields associated with the partition key rather than including all of that data in each of the clusterking key rows.</p>
<h4>Secondary index</h4>
<p>A secondary index allows you to query based on columns that are not part of the primary or clustering keys.</p>
<p>Do not use a secondary index when...</p>
<ul>
<li>The column has high (or very low) cardinality. (Cardinality is a measure of the number of elements in a set.) e.g., it would not be a good idea to make an index on an email column, where every entry will be unique. Also not a good idea to make an index on a boolean column where each entry will be one of two values.</li>
<li>The table contains a <code>counter</code> column.</li>
<li>The column is frequently updated or deleted.</li>
<li>The table has very large partitions.</li>
<li>Cassandra currently does not support indexing static columns.</li>
</ul>
<p>In cases where a secondary index cannot, or should not, be used, a separate table can be used as a manual index. For example, if you have a courses table with a static tags collections and you want to be able to query for courses by tag, you can create a separate table that has a primary key of (tag, course_id) which can serve as an index.</p>
<h3>Reads and Writes</h3>
<p>Each node in the cluster functions the same. The node that you connect to when making a query becomes the 'coordinator node'. Nodes that get written to in a statement are called 'replica nodes'.</p>
<p>Single data center consistency options:</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ONE</code></td>
<td>Write/read succeeds after writing/reading data to/from a single node.</td>
</tr>
<tr>
<td><code>TWO</code></td>
<td>Write/read succeeds after writing/reading data to/from two nodes.</td>
</tr>
<tr>
<td><code>THREE</code></td>
<td>Write/read succeeds after writing/reading data to/from three nodes.</td>
</tr>
<tr>
<td><code>QUORUM</code></td>
<td>Write/read succeeds after writing/reading data to/from a majority of the available nodes.</td>
</tr>
<tr>
<td><code>ALL</code></td>
<td>Write/read succeeds after writing/reading data to/from all of the available nodes.</td>
</tr>
<tr>
<td><code>ANY</code></td>
<td>Write/read succeeds after writing/reading data to/from any of the available nodes (including just making it to the coordinator node).</td>
</tr>
</tbody>
</table>
<p>Multiple data centers consistency options:</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>EACH_QUORUM</code></td>
<td>A quorum succeeds in each data center before returning success</td>
</tr>
<tr>
<td><code>LOCAL_QUORUM</code></td>
<td>A quorum succeeds in the data center that contains the coordinator node.</td>
</tr>
<tr>
<td><code>LOCAL_ONE</code></td>
<td>Same as ONE, but only looks in the data center of the coordinator node.</td>
</tr>
</tbody>
</table>
<p>If a node is down when a write occurs so that the node misses data, the data will be repaired during a read.</p>
<p>To see what the default consistency is, run <code>consistency;</code></p>
<p>To set the default consistency to use from the command line, use <code>consistency &lt;level&gt;;</code> e.g. <code>consistency quorum;</code></p>
<p>If the consistency required cannot be achieved, the read or write will fail.</p>
<h4>Batches</h4>
<p>A batch is not a transaction - it does not have rollback support. A batch does guarantee that every command in the batch will be executed. Batches are useful for keeping related data in sync.</p>
<pre><code class="language-sql"><span class="hljs-operator"><span class="hljs-keyword">BEGIN</span> BATCH

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span>
</span></code></pre>
<h3>tombstones</h3>
<p>When something is deleted in Cassandra, a tombstone is created. The tombstone is treated just a like a write, so that nodes that are down can be repaired. When the node that was down when the delete occurred comes back online, the normal read repair process will update the node with the tombstone.</p>
<p>Tombstones are automatically garbage collected on a configurable interval (default is 10 days). It is important not to clean up tombstones too quickly, because if the tombstones are removed, and then a node that was offline when the tombstone was created comes back online, the the read repair will restore the data from the node that was offline when the delete occurred, making it so that the data that was supposed to be deleted comes back into the database.</p></article><div id="sidebar" class="nav tablet-sidebar"><a href="/"><i class="fa fa-home fa-2x"></i><span>tech.joshegan.com</span></a><div class="author-profile"><img alt="author image" src="//www.gravatar.com/avatar/bd6b4be626e8bc1b30161f22a0de08ae?d=404&amp;amp;s=250" class="author-img"><div class="info"><h5>Josh Egan</h5><ul class="social"><li><a href="https://github.com/josh-egan" target="_blank" class="github"><i class="fa fa-github"></i></a></li></ul></div></div></div><div class="mobile-author-profile"><div class="separator"></div><div class="author-profile"><img alt="author image" src="//www.gravatar.com/avatar/bd6b4be626e8bc1b30161f22a0de08ae?d=404&amp;amp;s=250" class="author-img"><div class="info"><h5>Josh Egan</h5><ul class="social"><li><a href="https://github.com/josh-egan" target="_blank" class="github"><i class="fa fa-github"></i></a></li></ul></div></div><div class="separator"></div></div><div><div id="disqus_thread"></div><script type="text/javascript" async="true" src="//tech-joshegan.disqus.com/embed.js"></script><noscript>Please enable JavaScript to view the<a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div><div class="separator"></div><footer><div><span>Proudly built with <a href="http://harpjs.com/" target="_blank">harp </a>and hosted on <a href="https://github.com/josh-egan/tech.joshegan.com/tree/master" target="_blank">GitHub</a></span></div></footer></body></html>